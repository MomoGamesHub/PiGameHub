<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PiGamesHub | Final Patch</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root { --blue: #3b82f6; --gold: #f59e0b; --purple: #8b5cf6; }
        body { margin: 0; background: #f8fafc; font-family: sans-serif; color: #1e293b; text-align: center; }
        
        /* الهيدر الجديد */
        header { background: #fff; padding: 15px; border-bottom: 2px solid var(--purple); display: flex; justify-content: space-between; align-items: center; }
        
        /* كروت الإحصائيات مثل باى اب استوديو */
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .s-card { padding: 20px; border-radius: 15px; color: white; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .gold { background: linear-gradient(135deg, #f59e0b, #b45309); }

        /* زر الأكشن الكبير */
        .btn-box { margin: 20px; padding: 25px; border-radius: 20px; background: white; border: 2px dashed var(--purple); }
        .main-btn { background: var(--purple); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; font-size: 1rem; width: 100%; cursor: pointer; }
        .pay-btn { background: #10b981; margin-top: 15px; display: none; } /* مخفي حتى يتم تسجيل الدخول */
        
        .loading-text { color: var(--purple); font-size: 0.8rem; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; color: var(--purple);">PiGamesHub</div>
    <div id="user-status" style="font-size: 0.8rem;">غير متصل</div>
</header>

<div class="stats">
    <div class="s-card gold">
        <div id="game-coins">2450</div>
        <div style="font-size: 0.7rem;">عملات اللعبة</div>
    </div>
    <div class="s-card blue">
        <div id="pi-balance">0.00</div>
        <div style="font-size: 0.7rem;">Pi Balance</div>
    </div>
</div>

<div class="btn-box">
    <div id="step-1">
        <h3 style="color: var(--purple); margin-top: 0;">الخطوة 1: الدخول</h3>
        <p style="font-size: 0.9rem;">اضغط لتسجيل الدخول والموافقة على صلاحيات الدفع</p>
        <button class="main-btn" onclick="login()">تسجيل دخول Pi Network</button>
        <div id="loading" class="loading-text">جاري الاتصال بـ Pi Network...</div>
    </div>

    <div id="step-2" style="display: none;">
        <h3 style="color: #10b981; margin-top: 0;">الخطوة 2: التفعيل</h3>
        <p style="font-size: 0.9rem;">تم تسجيل الدخول! الآن يمكنك تفعيل المهمة البنفسجية</p>
        <button class="main-btn pay-btn" id="payBtn" style="display: block;" onclick="pay()">دفع 0.1 Pi للتفعيل</button>
    </div>
</div>

<script>
    const Pi = window.Pi;
    Pi.init({ version: "2.0", sandbox: true });

    async function login() {
        document.getElementById('loading').style.display = 'block';
        try {
            // نطلب الـ username والـ payments بوضوح
            const scopes = ['username', 'payments'];
            const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);
            
            // نجاح تسجيل الدخول
            document.getElementById('user-status').innerText = "أهلاً " + auth.user.username;
            document.getElementById('pi-balance').innerText = "125.56";
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            
            console.log("Login Success, Scope granted.");
        } catch (err) {
            alert("خطأ: " + err);
            document.getElementById('loading').style.display = 'none';
        }
    }

    function onIncompletePaymentFound(payment) {
        console.log("Payment incomplete", payment);
    }

    async function pay() {
        try {
            const payment = await Pi.createPayment({
                amount: 0.1,
                memo: "Activation for PiGamesHub Developer Task",
                metadata: { type: "activation" }
            }, {
                onReadyForServerApproval: (id) => console.log("Approved ID:", id),
                onReadyForServerCompletion: (id, txid) => {
                    alert("تمت العملية بنجاح! مبروك، المهمة البنفسجية اكتملت.");
                },
                onCancel: (id) => alert("تم إلغاء الدفع"),
                onError: (error) => alert("حدث خطأ أثناء الدفع: " + error.message)
            });
        } catch (err) {
            alert("فشل إنشاء الطلب: " + err.message);
        }
    }
</script>

</body>
</html>
