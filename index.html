<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>دومينو المحترفين - المسار الحر</title>
    <style>
        :root { --bone: #ffffff; --table: #0a4d34; --gold: #ffcc00; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }

        /* الطاولة: تسمح بالتمرير الأفقي والعمودي لمنع اختفاء القطع */
        #game-world {
            height: 70vh; width: 100vw; overflow: auto;
            background: radial-gradient(circle, var(--table) 0%, #052218 100%);
            display: flex; align-items: center; justify-content: center;
            border-bottom: 4px solid var(--gold); position: relative;
        }

        /* حاوية السلسلة: تتمدد مع إضافة القطع */
        #snake-chain {
            display: flex; align-items: center; gap: 5px; padding: 100px;
            min-width: min-content; transition: all 0.3s ease;
        }

        /* تصميم القطعة المحترف */
        .domino {
            width: 40px; height: 80px; background: var(--bone);
            border-radius: 5px; display: flex; flex-direction: column;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.5); border: 1px solid #999;
            flex-shrink: 0; position: relative;
        }
        .on-table { transform: rotate(90deg); margin: 0 15px; } /* وضعية النوم على الطاولة */

        .half { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); padding: 5px; }
        .dot { background: #000; border-radius: 50%; width: 6px; height: 6px; visibility: hidden; align-self: center; justify-self: center; }
        .line { height: 2px; background: #ddd; width: 80%; margin: 0 auto; }

        /* تفعيل النقاط */
        .v-1 .dot:nth-child(5), .v-2 .dot:nth-child(1), .v-2 .dot:nth-child(9),
        .v-3 .dot:nth-child(1), .v-3 .dot:nth-child(5), .v-3 .dot:nth-child(9),
        .v-4 .dot:nth-child(1), .v-4 .dot:nth-child(3), .v-4 .dot:nth-child(7), .v-4 .dot:nth-child(9),
        .v-5 .dot:nth-child(1), .v-5 .dot:nth-child(3), .v-5 .dot:nth-child(5), .v-5 .dot:nth-child(7), .v-5 .dot:nth-child(9),
        .v-6 .dot:nth-child(1), .v-6 .dot:nth-child(3), .v-6 .dot:nth-child(4), .v-6 .dot:nth-child(6), .v-6 .dot:nth-child(7), .v-6 .dot:nth-child(9) 
        { visibility: visible; }

        /* منطقة التحكم واليد */
        .hud { height: 30vh; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hand { display: flex; gap: 10px; margin-bottom: 20px; height: 90px; }
        .hand .domino { cursor: pointer; transition: 0.2s; }
        .hand .domino:hover { transform: translateY(-15px); border-color: var(--gold); }
        
        .controls { display: flex; gap: 20px; align-items: center; }
        .btn { background: var(--gold); border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        .btn:disabled { background: #444; color: #888; }
        .info { font-size: 1.2rem; color: var(--gold); }
    </style>
</head>
<body>

<div id="game-world">
    <div id="snake-chain">
        </div>
</div>

<div class="hud">
    <div class="info">أنت: <span id="pS">0</span> | الخصم: <span id="aS">0</span> | السحب: <span id="bC">0</span></div>
    <div id="status" style="margin: 5px; color: #aaa;">اسحب قطعة أو العب</div>
    <div class="hand" id="player-hand"></div>
    <div class="controls">
        <button class="btn" id="drawBtn" onclick="drawTile()">سحب قطعة</button>
        <button class="btn" id="passBtn" onclick="passTurn()" disabled>تمرير (Pass)</button>
        <button class="btn" style="background:#555; color:white" onclick="location.reload()">إعادة اللعبة</button>
    </div>
</div>

<script>
    let boneyard = [], pHand = [], aiHand = [], chain = [];
    let L = -1, R = -1, scores = {p:0, ai:0};

    function init() {
        boneyard = [];
        for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) boneyard.push({a:i, b:j});
        boneyard.sort(() => Math.random() - 0.5);
        
        pHand = boneyard.splice(0, 7);
        aiHand = boneyard.splice(0, 7);
        render();
    }

    function createUI(a, b, onTable) {
        const d = document.createElement('div');
        d.className = `domino ${onTable ? 'on-table' : ''}`;
        d.innerHTML = `<div class="half v-${a}">${Array(9).fill('<div class="dot"></div>').join('')}</div><div class="line"></div><div class="half v-${b}">${Array(9).fill('<div class="dot"></div>').join('')}</div>`;
        return d;
    }

    function render() {
        const handDiv = document.getElementById('player-hand');
        handDiv.innerHTML = '';
        pHand.forEach((t, i) => {
            const el = createUI(t.a, t.b, false);
            el.onclick = () => play(i);
            handDiv.appendChild(el);
        });

        const chainDiv = document.getElementById('snake-chain');
        chainDiv.innerHTML = '';
        chain.forEach(t => chainDiv.appendChild(createUI(t.a, t.b, true)));

        document.getElementById('bC').innerText = boneyard.length;
        document.getElementById('pS').innerText = scores.p;
        document.getElementById('aS').innerText = scores.ai;

        checkRules();
        // تمرير تلقائي لآخر قطعة مضافة
        document.getElementById('game-world').scrollLeft = 10000; 
    }

    function play(idx) {
        let t = pHand[idx];
        let played = false;

        if (L === -1) { 
            L = t.a; R = t.b; chain.push(t); played = true; 
        } else if (t.a === L || t.b === L) {
            if (t.a === L) [t.a, t.b] = [t.b, t.a];
            L = t.a; chain.unshift(t); played = true;
        } else if (t.a === R || t.b === R) {
            if (t.b === R) [t.a, t.b] = [t.b, t.a];
            R = t.b; chain.push(t); played = true;
        }

        if (played) {
            pHand.splice(idx, 1);
            if (pHand.length === 0) return endRound('p');
            render();
            setTimeout(aiMove, 800);
        }
    }

    function aiMove() {
        let idx = aiHand.findIndex(t => t.a === L || t.b === L || t.a === R || t.b === R);
        if (idx !== -1) {
            let t = aiHand[idx];
            if (t.a === L || t.b === L) {
                if (t.a === L) [t.a, t.b] = [t.b, t.a];
                L = t.a; chain.unshift(t);
            } else {
                if (t.b === R) [t.a, t.b] = [t.b, t.a];
                R = t.b; chain.push(t);
            }
            aiHand.splice(idx, 1);
            if (aiHand.length === 0) return endRound('ai');
        } else if (boneyard.length > 0) {
            aiHand.push(boneyard.shift());
            return aiMove();
        }
        render();
    }

    function checkRules() {
        const canP = pHand.some(t => t.a === L || t.b === L || t.a === R || t.b === R || L === -1);
        const canAI = aiHand.some(t => t.a === L || t.b === L || t.a === R || t.b === R);
        
        document.getElementById('drawBtn').disabled = (boneyard.length === 0);
        document.getElementById('passBtn').disabled = (canP || boneyard.length > 0);

        // منطق القفلة
        if (!canP && !canAI && boneyard.length === 0) {
            let pSum = pHand.reduce((s, t) => s + t.a + t.b, 0);
            let aiSum = aiHand.reduce((s, t) => s + t.a + t.b, 0);
            alert(`القفلة! مجموعك: ${pSum} | مجموع الخصم: ${aiSum}`);
            endRound(pSum < aiSum ? 'p' : 'ai');
        }
    }

    function drawTile() { if(boneyard.length > 0) { pHand.push(boneyard.shift()); render(); } }
    function passTurn() { setTimeout(aiMove, 500); }

    function endRound(winner) {
        let pts = 0;
        if (winner === 'p') aiHand.forEach(t => pts += (t.a + t.b));
        else pHand.forEach(t => pts += (t.a + t.b));
        scores[winner] += pts;
        alert(`نهاية الدور! فاز ${winner==='p'?'أنت':'الخصم'} بـ ${pts} نقطة`);
        chain = []; L = -1; R = -1;
        init();
    }

    init();
</script>
</body>
</html>
