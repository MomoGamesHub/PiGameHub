<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiGamesHub | 4-Players AI Edition</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root { --primary: #6741d9; --accent: #ffd700; --bg: #05010a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* واجهة اللعب الكبرى */
        #game-table {
            display: none; position: fixed; inset: 0; 
            background: radial-gradient(circle, #1a472a 0%, #05150a 100%);
            z-index: 3000; flex-direction: column;
        }

        /* توزيع اللاعبين الأربعة */
        .table-area {
            flex-grow: 1; position: relative; display: flex;
            align-items: center; justify-content: center;
        }

        .player-slot {
            position: absolute; padding: 10px; background: rgba(0,0,0,0.5);
            border-radius: 15px; border: 1px solid var(--primary); font-size: 0.8rem;
        }
        .slot-top { top: 20px; }
        .slot-left { left: 20px; transform: rotate(90deg); }
        .slot-right { right: 20px; transform: rotate(-90deg); }
        .slot-bottom { bottom: 120px; border-color: var(--accent); }

        #main-board {
            width: 70%; height: 50%; border: 4px dashed rgba(255,255,255,0.1);
            border-radius: 20px; display: flex; align-items: center; 
            justify-content: center; gap: 5px; flex-wrap: wrap; overflow-y: auto;
        }

        /* قطع الدومينو */
        .tile {
            width: 35px; height: 70px; background: white; border-radius: 4px;
            display: flex; flex-direction: column; border: 2px solid #222;
            cursor: pointer; flex-shrink: 0; transition: 0.3s;
        }
        .tile.horizontal { transform: rotate(90deg); margin: 0 15px; }
        .t-part { flex: 1; color: black; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 900; }
        .t-part:first-child { border-bottom: 2px solid #222; }

        #my-hand {
            height: 100px; background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; gap: 8px; padding: 10px;
        }

        .active-turn { box-shadow: 0 0 20px var(--accent); border: 2px solid var(--accent); }

        /* الأكواد السابقة للواجهة */
        .universe-bg { position: fixed; inset: 0; background: radial-gradient(circle, #1a0b35, #05010a); z-index: -1; }
        header { padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(20px); border-bottom: 1px solid rgba(103,65,217,0.3); }
        .auth-btn { background: linear-gradient(45deg, var(--primary), #8e44ad); border: none; color: white; padding: 10px 20px; border-radius: 50px; cursor: pointer; }
        .games-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; max-width: 500px; margin: auto; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 30px; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .card img { width: 80px; animation: float 4s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        #domino-lobby {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
        }
        .mode-btn { background: var(--glass); border: 2px solid var(--primary); padding: 15px; border-radius: 15px; width: 250px; margin: 10px; cursor: pointer; color: white; text-align: center; }
        .mode-btn:hover { background: var(--primary); }
    </style>
</head>
<body>

    <div class="universe-bg"></div>

    <header>
        <div style="font-weight: 900; color: var(--accent);">PiGamesHub</div>
        <button class="auth-btn" id="pi-user" onclick="handleLogin()">اتصال Pi</button>
    </header>

    <div id="main-ui" class="games-grid">
        <div class="card" onclick="document.getElementById('domino-lobby').style.display='flex'">
            <img src="domino.png.png">
            <span>دومينو 4 لاعبين</span>
        </div>
        <div class="card"><img src="chess.png.png"><span>قريباً</span></div>
    </div>

    <div id="domino-lobby">
        <h2 style="color: var(--accent);">اختر وضع اللعب</h2>
        <div class="mode-btn" onclick="startFullGame('solo')">لعب ضد الكمبيوتر (4 لاعبين)</div>
        <div class="mode-btn" onclick="alert('سيتم تفعيل اللعب الأونلاين قريباً')">لعب أونلاين (Multiplayer)</div>
        <button onclick="document.getElementById('domino-lobby').style.display='none'" style="color: red; background: none; border: none; cursor: pointer;">إغلاق</button>
    </div>

    <div id="game-table">
        <div style="padding: 10px; display: flex; justify-content: space-between;">
            <span id="turn-indicator">دورك الآن</span>
            <button onclick="location.reload()" style="background: red; color: white; border: none; border-radius: 5px; padding: 5px 10px;">انسحاب</button>
        </div>

        <div class="table-area">
            <div class="player-slot slot-top" id="p2">الكمبيوتر 2 (7 قطع)</div>
            <div class="player-slot slot-left" id="p1">الكمبيوتر 1 (7 قطع)</div>
            <div class="player-slot slot-right" id="p3">الكمبيوتر 3 (7 قطع)</div>
            <div class="player-slot slot-bottom" id="p0">أنت (7 قطع)</div>

            <div id="main-board"></div>
        </div>

        <div id="my-hand"></div>
    </div>

    <script>
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: true });

        async function handleLogin() {
            try {
                const auth = await Pi.authenticate(['username'], (p)=>{});
                document.getElementById('pi-user').innerText = auth.user.username;
            } catch (e) { alert("افتح من Pi Browser"); }
        }

        let players = [[], [], [], []]; // 4 لاعبين
        let board = [];
        let currentTurn = 0; // 0=أنت، 1-3=كمبيوتر

        function startFullGame() {
            document.getElementById('domino-lobby').style.display = 'none';
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('game-table').style.display = 'flex';
            
            initDeck();
        }

        function initDeck() {
            let deck = [];
            for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) deck.push([i, j]);
            deck.sort(() => Math.random() - 0.5);

            for(let p=0; p<4; p++) players[p] = deck.splice(0, 7);
            
            updateUI();
            checkTurn();
        }

        function updateUI() {
            const handDiv = document.getElementById('my-hand');
            handDiv.innerHTML = "";
            players[0].forEach((t, i) => {
                const d = document.createElement('div');
                d.className = 'tile';
                d.innerHTML = `<div class="t-part">${t[0]}</div><div class="t-part">${t[1]}</div>`;
                d.onclick = () => userPlay(i);
                handDiv.appendChild(d);
            });

            for(let i=1; i<=3; i++) {
                document.getElementById(`p${i}`).innerText = `كمبيوتر ${i} (${players[i].length} قطع)`;
            }
        }

        function userPlay(idx) {
            if(currentTurn !== 0) return;
            const tile = players[0][idx];
            
            if(canPlay(tile)) {
                addToBoard(tile, 0);
                players[0].splice(idx, 1);
                nextTurn();
            } else {
                alert("هذه القطعة لا تناسب اللوحة!");
            }
        }

        function canPlay(tile) {
            if(board.length === 0) return true;
            let left = board[0][0];
            let right = board[board.length-1][1];
            return tile.includes(left) || tile.includes(right);
        }

        function addToBoard(tile, pIdx) {
            if(board.length === 0) {
                board.push(tile);
            } else {
                let left = board[0][0];
                let right = board[board.length-1][1];
                if(tile.includes(left)) {
                    if(tile[1] === left) board.unshift(tile);
                    else board.unshift([tile[1], tile[0]]);
                } else {
                    if(tile[0] === right) board.push(tile);
                    else board.push([tile[1], tile[0]]);
                }
            }
            renderBoard();
            updateUI();
        }

        function renderBoard() {
            const b = document.getElementById('main-board');
            b.innerHTML = "";
            board.forEach(t => {
                const d = document.createElement('div');
                d.className = 'tile horizontal';
                d.innerHTML = `<div class="t-part">${t[0]}</div><div class="t-part">${t[1]}</div>`;
                b.appendChild(d);
            });
        }

        function nextTurn() {
            currentTurn = (currentTurn + 1) % 4;
            checkTurn();
        }

        function checkTurn() {
            document.querySelectorAll('.player-slot').forEach(s => s.classList.remove('active-turn'));
            document.getElementById(`p${currentTurn}`).classList.add('active-turn');

            if(currentTurn !== 0) {
                document.getElementById('turn-indicator').innerText = `كمبيوتر ${currentTurn} يفكر...`;
                setTimeout(aiMove, 1500);
            } else {
                document.getElementById('turn-indicator').innerText = "دورك الآن";
            }
        }

        function aiMove() {
            let hand = players[currentTurn];
            let playIdx = hand.findIndex(t => canPlay(t));

            if(playIdx !== -1) {
                addToBoard(hand[playIdx], currentTurn);
                hand.splice(playIdx, 1);
            } else {
                console.log(`كمبيوتر ${currentTurn} لم يجد قطعة!`);
            }
            
            if(hand.length === 0) {
                alert(`انتهت اللعبة! الفائز هو لاعب ${currentTurn}`);
                location.reload();
            } else {
                nextTurn();
            }
        }
    </script>
</body>
</html>
