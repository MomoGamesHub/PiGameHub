<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi Game Hub - Pro</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root {
            --pi-purple: #673ab7;
            --bg-light: #f8f9fa;
            --text-dark: #333;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        body { margin: 0; background: var(--bg-light); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-dark); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙ‰ Ø§Ù„Ù…Ø·ÙˆØ± */
        .top-bar {
            background: white; padding: 10px 15px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 2px solid #eee; position: sticky; top: 0; z-index: 100;
        }
        .stats-box { display: flex; gap: 8px; font-size: 13px; }
        .pi-balance { background: #fff8e1; color: #f59e0b; padding: 4px 10px; border-radius: 15px; font-weight: bold; border: 1px solid #ffe082; }
        .user-level { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 15px; font-weight: bold; border: 1px solid #c8e6c9; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #auth-section, #game-dashboard, #actual-game { padding: 20px; text-align: center; }
        #game-dashboard, #actual-game { display: none; }

        .auth-card { background: white; padding: 30px; border-radius: 20px; box-shadow: var(--card-shadow); max-width: 400px; margin: 0 auto; }
        
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .game-card { background: white; border-radius: 15px; padding: 15px; box-shadow: var(--card-shadow); border: 1px solid #f0f0f0; cursor: pointer; }
        .game-card img { width: 50px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .domino-area { background: #2e7d32; padding: 20px; border-radius: 20px; min-height: 200px; margin-top: 20px; color: white; }
        .hand { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .domino-piece { width: 40px; height: 80px; background: white; border: 2px solid #000; color: black; display: flex; flex-direction: column; border-radius: 5px; font-weight: bold; }
        .half { flex: 1; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #ddd; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-main { background: var(--pi-purple); color: white; }
        
        #pay-overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); color:white; z-index: 1000;
            justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div id="username-display" style="font-weight: bold; color: var(--pi-purple);">Pi Game Hub</div>
    <div class="stats-box">
        <div class="user-level" id="level-ui">LVL 1</div>
        <div class="pi-balance" id="user-balance">0.00 Pi</div>
    </div>
</div>

<div id="auth-section">
    <div class="auth-card">
        <img src="https://minepi.com/wp-content/uploads/2021/10/logo.png" width="60" alt="Pi">
        <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø·ÙˆØ± Pi</h2>
        <p>Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¨Ø¯Ø¡ Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
        <button id="authBtn" class="btn btn-main" onclick="startPiAuth()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ù‡ÙˆÙŠØ©</button>
    </div>
</div>

<div id="game-dashboard">
    <h3 style="text-align: right;">Ø§Ø®ØªØ± Ù„Ø¹Ø¨ØªÙƒ ğŸ®</h3>
    <div class="game-grid">
        <div class="game-card" onclick="requestGamePayment('Domino')">
            <div style="font-size: 30px;">ğŸ´</div>
            <h4>Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ</h4>
            <p style="font-size: 11px; color: #888;">0.1 Pi Ù„Ù„Ø¹Ø¨</p>
            <button class="btn btn-main" style="padding: 5px; font-size: 12px;">Ø¯ÙØ¹ ÙˆØ§Ù„Ù„Ø¹Ø¨</button>
        </div>
        <div class="game-card" style="opacity: 0.6;">
            <div style="font-size: 30px;">ğŸ²</div>
            <h4>Ù„ÙˆØ¯Ùˆ</h4>
            <p style="font-size: 11px;">Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
        </div>
    </div>
</div>

<div id="actual-game">
    <button onclick="backToDashboard()" style="float: right; background: none; border: none; color: var(--pi-purple); font-weight: bold;">âœ• Ø®Ø±ÙˆØ¬</button>
    <h3>Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ ğŸƒ</h3>
    <div class="domino-area" id="board">
        <p id="game-status">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø³Ø­Ø¨ Ù‚Ø·Ø¹Ø©" Ù„Ù„Ø¨Ø¯Ø¡</p>
        <div class="hand" id="player-hand"></div>
    </div>
    <button class="btn btn-main" onclick="drawDomino()">Ø³Ø­Ø¨ Ù‚Ø·Ø¹Ø© (+10 Ù†Ù‚Ø§Ø·)</button>
    <div style="margin-top: 15px; color: #666;">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="score-val">0</span></div>
</div>

<div id="pay-overlay">
    <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</h3>
    <p>ÙØªØ­ "Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ" Ù…Ù‚Ø§Ø¨Ù„ 0.1 Pi</p>
    <button class="btn btn-main" onclick="createPiPayment()" style="width: 200px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</button>
    <button onclick="document.getElementById('pay-overlay').style.display='none'" style="background:none; border:none; color:white; margin-top:20px;">ØªØ±Ø§Ø¬Ø¹</button>
</div>

<script>
    const Pi = window.Pi;
    Pi.init({ version: "2.0", sandbox: false });

    let score = 0;
    let level = 1;

    async function startPiAuth() {
        try {
            const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
            document.getElementById('username-display').innerText = "@" + auth.user.username;
            document.getElementById('user-balance').innerText = "125.56 Pi"; 
            document.getElementById('auth-section').style.display = "none";
            document.getElementById('game-dashboard').style.display = "block";
        } catch (err) { alert("ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Pi Browser"); }
    }

    function requestGamePayment(game) {
        document.getElementById('pay-overlay').style.display = "flex";
    }

    async function createPiPayment() {
        try {
            await Pi.createPayment({
                amount: 0.1,
                memo: "ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©",
                metadata: { orderId: "PRO-" + Date.now() }
            }, {
                onReadyForServerApproval: (id) => handleServer(id, 'approve'),
                onReadyForServerCompletion: (id, txid) => {
                    handleServer(id, 'complete', txid);
                    launchGame();
                },
                onCancel: () => {},
                onError: (err) => alert(err.message)
            });
        } catch (e) { console.error(e); }
    }

    function launchGame() {
        document.getElementById('pay-overlay').style.display = "none";
        document.getElementById('game-dashboard').style.display = "none";
        document.getElementById('actual-game').style.display = "block";
    }

    function drawDomino() {
        const hand = document.getElementById('player-hand');
        document.getElementById('game-status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù„Ø¹Ø¨...";
        
        const piece = document.createElement('div');
        piece.className = 'domino-piece';
        const v1 = Math.floor(Math.random() * 7);
        const v2 = Math.floor(Math.random() * 7);
        piece.innerHTML = `<div class="half">${v1}</div><div class="half">${v2}</div>`;
        hand.appendChild(piece);

        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰
        score += 10;
        document.getElementById('score-val').innerText = score;
        if(score >= 100) {
            level = 2;
            document.getElementById('level-ui').innerText = "LVL 2";
            document.getElementById('level-ui').style.background = "#fff3e0";
        }
    }

    function backToDashboard() {
        document.getElementById('actual-game').style.display = "none";
        document.getElementById('game-dashboard').style.display = "block";
    }

    async function handleServer(paymentId, action, txid = null) {
        try {
            await fetch('/api/pi-handler', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId, action, txid })
            });
        } catch (e) { console.error(e); }
    }

    function onIncompletePaymentFound(p) {
        handleServer(p.identifier, 'complete', p.transaction.txid);
    }
</script>

</body>
</html>
