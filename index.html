<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.1/dist/ethers.umd.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  // ================= Firebase Config =================
  const firebaseConfig = {
    apiKey: "AIzaSyCn581B_OaIYc7crz3V2Lrjf9WOtJdRe60",
    authDomain: "pigameshub.firebaseapp.com",
    databaseURL: "https://pigameshub-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "pigameshub",
    storageBucket: "pigameshub.firebasestorage.app",
    messagingSenderId: "977510299690",
    appId: "1:977510299690:web:2e146161feeeefb5486b53",
    measurementId: "G-CGKZZK48G4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ================= Connect Wallet =================
  let userAddress = null;
  let provider = null;

  async function connectWallet() {
    if (typeof window.ethereum !== 'undefined') {
      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        userAddress = accounts[0];

        const network = await provider.getNetwork();
        alert(`تم الاتصال بالمحفظة: ${userAddress}\nالشبكة: ${network.name} (${network.chainId})`);
      } catch(err) {
        alert('فشل الاتصال بالمحفظة');
        console.error(err);
      }
    } else {
      alert('الرجاء تثبيت MetaMask أو أي محفظة EVM');
    }
  }

  // زر الاتصال بالمحفظة
  const connectBtn = document.createElement('button');
  connectBtn.innerText = "Connect Wallet";
  connectBtn.style.margin = "20px";
  connectBtn.onclick = connectWallet;
  document.body.insertBefore(connectBtn, document.getElementById("cards"));

  // ================= Game Cards Click =================
  const cards = document.querySelectorAll('.card');
  cards.forEach((card, i) => {
    card.onclick = async () => {
      if(!userAddress) { alert('الرجاء توصيل المحفظة أولاً'); return; }

      const cardRef = ref(db, 'cards/' + (i+1));
      const snapshot = await get(cardRef);
      let count = 1;
      let users = [];
      if(snapshot.exists()) {
        const data = snapshot.val();
        count = data.count + 1;
        users = data.users || [];
      }

      const now = new Date().toLocaleString("ar-EG", { hour12: false });
      if(!users.includes(userAddress)) users.push(userAddress);

      await set(cardRef, {
        count: count,
        lastClick: now,
        users: users,
        network: provider ? (await provider.getNetwork()).name : "unknown"
      });

      card.style.transform = "translateY(-30px)";
      alert(`كارت ${i+1} تم تسجيله!\nعدد الضغطات: ${count}\nالمستخدمين: ${users.length}\nالشبكة: ${(await provider.getNetwork()).name}\nالوقت: ${now}`);
    }
  });
</script>
